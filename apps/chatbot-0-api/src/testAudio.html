<!DOCTYPE html>
<html>
<head>
  <title>Live Speech Translation</title>
</head>
<body>
<h1>Live Audio Translator</h1>
<audio id="translationAudio" controls ></audio>
<button id="startBtn">Start Speaking</button>
<button id="stopBtn" disabled>Stop</button>
<div id="transcriptLog"></div>
<script>
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");
  let pc;
  let localStream;
  let sessionId = null;

  function appendLine(text) {
    const div = document.getElementById('transcriptLog');
    const p = document.createElement('div');
    p.textContent = text;
    div.appendChild(p);
  }

  startBtn.addEventListener("click", async () => {
    startBtn.disabled = true;
    stopBtn.disabled = false;

    pc = new RTCPeerConnection();

    const audioEl = document.getElementById('translationAudio');
    pc.ontrack = (event) => {
      console.log('Received remote stream');
      const [stream] = event.streams;
      if (stream) audioEl.srcObject = stream;
    };

    pc.onconnectionstatechange = () => {
      console.log('Connection state change:', pc.connectionState);
      if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected' || pc.connectionState === 'closed') {
        alert('Connection closed. Please refresh the page to try again.');
      }
    };

    pc.ondatachannel = (event) => {
      console.log('Received datachannel');
      event.channel.onmessage = (msg) => {
        try {
          const data = JSON.parse(msg.data);
          if (data.type === 'transcript') appendLine(data.delta);
        } catch (e) {
          console.log('Non-JSON datachannel message', msg.data);
        }
      };
    };

    pc.onicecandidate = (event) => {
      if (event.candidate) return;
      fetch("/realtime/webrtc/offer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ offer: pc.localDescription }),
      })
        .then((res) => {
          if (!res.ok) {
            return res.text().then(t => { throw new Error(`Server error ${res.status}: ${t}`); });
          }
          return res.json();
        })
        .then((data) => {
          console.log(data.answer);
          sessionId = data.sessionId || null;
          if (sessionId) console.log('Got sessionId:', sessionId);
          pc.setRemoteDescription(data.answer);
        })
        .catch(err => {
          console.error('Offer request failed:', err);
          alert('Offer request failed: ' + err.message);
        });
    };


    localStream = await navigator.mediaDevices.getUserMedia({ audio: true });
    localStream.getTracks().forEach((track) => pc.addTrack(track, localStream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
  });

  stopBtn.addEventListener('click', async () => {
    stopBtn.disabled = true;
    startBtn.disabled = false;

    // Notify server to stop the session if we have a sessionId
    try {
      if (sessionId) {
        await fetch('/realtime/stop', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ sessionId }),
        });
        console.log('Requested server to stop session', sessionId);
        sessionId = null;
      }
    } catch (err) {
      console.error('Failed to request server stop:', err);
    }

    // Close peer connection and stop local tracks
    try {
      if (localStream) {
        localStream.getTracks().forEach(t => t.stop());
      }
      if (pc) {
        pc.getSenders().forEach(s => { try { s.track?.stop?.(); } catch (e) {} });
        pc.close();
      }
    } catch (err) {
      console.error('Error closing local PC/streams:', err);
    }

    // enable start again
    startBtn.disabled = false;
    stopBtn.disabled = true;
  });
</script>
</body>
</html>
