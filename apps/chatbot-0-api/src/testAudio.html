<!DOCTYPE html>
<html>
<head>
  <title>Live Speech Translation</title>
</head>
<body>
<h1>Live Audio Translator</h1>
<audio id="translationAudio" controls ></audio>
<button id="startBtn">Start Speaking</button>
<div id="transcriptLog"></div>
<script>
  const startBtn = document.getElementById("startBtn");
  let pc;


  startBtn.addEventListener("click", async () => {
    pc = new RTCPeerConnection();

    const audioEl = document.getElementById('translationAudio');
    pc.ontrack = (event) => {
      console.log('Received remote stream');
      const [stream] = event.streams;
      if (stream) audioEl.srcObject = stream;
    };

    pc.onconnectionstatechange = () => {
      console.log('Connection state change:', pc.connectionState);
      if (pc.connectionState === 'failed' || pc.connectionState === 'disconnected' || pc.connectionState === 'closed') {
        alert('Connection closed. Please refresh the page to try again.');
      }
    };

    pc.ondatachannel = (event) => {
      console.log('Received datachannel');
      // if (event.channel.label !== 'translation') return;
      event.channel.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if (data.type === 'transcript') appendLine(data.delta);
      };
    };

    pc.onicecandidate = (event) => {
      if (event.candidate) return;
      fetch("/realtime/webrtc/offer", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ offer: pc.localDescription }),
      })
        .then((res) => {
          if (!res.ok) {
            return res.text().then(t => { throw new Error(`Server error ${res.status}: ${t}`); });
          }
          return res.json();
        })
        .then((data) => {
          console.log(data.answer);
          pc.setRemoteDescription(data.answer);
        })
        .catch(err => {
          console.error('Offer request failed:', err);
          alert('Offer request failed: ' + err.message);
        });
    };


    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
    stream.getTracks().forEach((track) => pc.addTrack(track, stream));

    const offer = await pc.createOffer();
    await pc.setLocalDescription(offer);
  });
</script>
</body>
</html>
